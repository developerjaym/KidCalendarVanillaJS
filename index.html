<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidCalendar</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html {
            font-family: sans-serif;
            background-color: gainsboro;
        }

        #app {
            display: grid;
            grid-template-areas: 'area';
            margin: 0;

            grid-area: area;
            z-index: 1;
            max-height: 100vh;
        }

        form {
            display: flex;
            flex-direction: column;
            row-gap: 4px;
        }

        form label {
            display: flex;
            flex-direction: column;
            row-gap: 2px;
        }

        input, select {
            border-width: 0 0 1px 0;
            border-style: solid;
            border-color: black;
        }

        .toolbar {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;

            padding: 0.5rem;

            background-color: lightgray;
            color: black;

            border-width: 0 0 1px 0;
            border-style: solid;
            border-color: black;

        }

        h2 {
            background-color: firebrick;
            color: rgba(255, 255, 255, 0.66);
            padding: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 1px 2px 12px black;
            font-weight: normal;
            transform: rotate(-1.5deg);
        }

        select {
            text-transform: capitalize;
        }

        .button {
            border-width: 1px;
            border-color: transparent;
            border-style: solid;
        }

        .button:active {
            border-color: black;
            border-width: 1px;
            border-style: solid;
        }

        .button:hover {
            border-color: black;
            border-width: 1px;
            border-style: dotted;
        }

        .button-icon {
            background-color: transparent;
            color: black;
            border-radius: 1rem;
        }

        .button-submit {
            background-color: lightgreen;
            padding: 0.5rem;
        }

        form:invalid .button-submit {
            background-color: rgba(144, 238, 144, 0.15);
            color: rgba(0, 0, 0, 0.15);
        }

        #calendarArea {
            grid-area: area;
            z-index: 1;

            max-height: 100vh;
            overflow-y: clip;
        }

        #calendarList {

            display: flex;
            flex-direction: column;
            row-gap: 0.5rem;
            align-items: center;

            max-height: 100vh;
            overflow-y: scroll;

            padding: 0.5rem 0.5rem 15rem 0.5rem;

        }

        .calendar-entry {
            min-height: 15rem;
            width: 15rem;

            padding: 0.25rem;

            background-color: yellow;
            color: black;

            display: flex;
            flex-direction: column;
            row-gap: 0.25rem;

            border-width: 0.5rem;
            border-style: solid;
        }

        .calendar-entry__header {
            margin: 0.25rem;
        }

        .calendar-entry__activity {
            display: flex;
            justify-content: space-between;
            align-items: center;

            border: none;

            padding: 0.5rem;
        }

        .modal-container {
            z-index: 2;
            grid-area: area;

            background-color: rgba(128, 128, 128, 0.576);

            display: flex;
            align-items: center;
            justify-content: center;

            height: 100%;
            width: 100%;
        }

        .modal {
            height: fit-content;
            width: fit-content;
            padding: 12px 24px 24px 24px;

            background-color: white;

            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body id="app">

    <div id="calendarArea">
        <div class="toolbar">
            <h2>Calendar</h2>
            <label>
                <input id="visibleDaysInput" type="number" max="365" min="1">
                Visible Days
            </label>
        </div>
        <div id="calendarList">

        </div>
    </div>
    <script>
        class Classes {
            static SELECTED = 'selected';

        }
        class Colors {
            static YELLOW = 'yellow';
            static RED = 'firebrick';
            static GREENYELLOW = 'greenyellow';
            static PINK = 'pink';
            static PURPLE = 'purple';
            static TRANSPARENT = 'transparent';
            static WEEKDAY = Colors.YELLOW;
            static WEEKEND = Colors.PURPLE;
            static ALL = [Colors.YELLOW, Colors.GREENYELLOW, Colors.PINK, Colors.RED, Colors.PURPLE, Colors.TRANSPARENT];
        }

        class IdentifierUtility {
            static generateRandomId() {
                return Math.floor((Math.random() * 10000000000) + 1);
            }
        }

        class DateUtility {
            static dateToDateString(date) {
                return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
            }
            static dateStringToDate(dateString) {
                return new Date(dateString);
            }
            static isWeekend(date) {
                return date.getDay() === 0 || date.getDay() === 6;
            }
            static getToday() {
                return new Date();
            }
        }

        class Observer {
            constructor() {
            }
            onUpdate(state) {
                throw 'onUpdate must be implemented by ' + this;
            }
        }

        class Observable {
            #observers;
            constructor() {
                this.#observers = [];
            }
            addObserver(observer) {
                this.#observers.push(observer);
            }
            notifyAll(state) {
                this.#observers.forEach(observer => observer.onUpdate(state.asData()));
            }
        }

        class State {
            constructor(daysVisible = 7, calendarEntries = {}) {
                this.daysVisible = daysVisible;
                this.calendarEntries = calendarEntries;
            }
            add(date, entry) {
                this.calendarEntries[date] = entry;
            }
            contains(date) {
                return Boolean(this.calendarEntries[date]);
            }
            addActivity(date, activity) {
                this.calendarEntries[date].addActivity(activity);
            }
            removeActivity(date, activityId) {
                this.calendarEntries[date].removeActivity(activityId);
            }
            clearEntries() {
                this.calendarEntries = {};
            }
            setDaysVisible(newValue) {
                this.daysVisible = newValue;
            }
            asData() {
                return JSON.parse(JSON.stringify(this));
            }
            static fromData(data) {
                if (!data) {
                    return null;
                }
                for (let ce in data.calendarEntries) {
                    const original = data.calendarEntries[ce];
                    data.calendarEntries[ce] = CalendarEntry.fromData(original);//new CalendarEntry(DateUtility.dateStringToDate(original.dateString), original.activities, original.color)
                }
                return new State(data.daysVisible, data.calendarEntries);
            }
        }

        class DayOfWeek {
            static SUNDAY = new DayOfWeek('Sunday', 'Sun.', true, 0);
            static MONDAY = new DayOfWeek('Monday', 'Mon.', false, 1);
            static TUESDAY = new DayOfWeek('Tuesday', 'Tues.', false, 2);
            static WEDNESDAY = new DayOfWeek('Wednesday', 'Wed.', false, 3);
            static THURSDAY = new DayOfWeek('Thursday', 'Thu.', false, 4);
            static FRIDAY = new DayOfWeek('Friday', 'Fri.', false, 5);
            static SATURDAY = new DayOfWeek('Saturday', 'Sat.', true, 6);
            static #allDays = [DayOfWeek.SUNDAY, DayOfWeek.MONDAY, DayOfWeek.TUESDAY, DayOfWeek.WEDNESDAY, DayOfWeek.THURSDAY, DayOfWeek.FRIDAY, DayOfWeek.SATURDAY];
            constructor(name, shortName, isWeekend, number) {
                this.name = name;
                this.shortName = shortName
                this.isWeekend = isWeekend;
                this.number = number;
            }
            static fromNumber(number) {
                return DayOfWeek.#allDays.find(day => day.number === number);
            }
        }

        class CalendarEntryActivity {
            constructor(text, color = Colors.TRANSPARENT) {
                this.text = text;
                this.color = color;
                this.id = IdentifierUtility.generateRandomId();
            }
            static fromData(data) {
                return new CalendarEntryActivity(data.text, data.color);
            }
        }

        class CalendarEntry {
            constructor(date, activities = [], color = Colors.WEEKDAY) {
                this.dateString = DateUtility.dateToDateString(date);
                this.activities = activities;
                this.isWeekend = DateUtility.isWeekend(date);
                this.color = color || (this.isWeekend ? Colors.WEEKEND : Colors.WEEKDAY);
            }
            addActivity(activity) {
                this.activities.push(activity);
            }
            removeActivity(activityId) {
                this.activities.splice(this.activities.findIndex(activity => activity.id === activityId), 1);
            }
            static fromData(data) {
                return new CalendarEntry(DateUtility.dateStringToDate(data.dateString), data.activities.map(activity => CalendarEntryActivity.fromData(activity)), data.color);
            }
        }

        class Model extends Observable {
            #state;
            constructor(state = new State()) {
                super();
                this.#state = state;
            }
            start() {
                this.notifyAll(this.#state);
            }
            setDaysVisible(newDaysVisible) {
                this.#state.setDaysVisible(newDaysVisible)
                this.notifyAll(this.#state);
            }
            addActivity(date, newActivity) {
                if (!this.#state.contains(DateUtility.dateToDateString(date))) {
                    this.#state.add(DateUtility.dateToDateString(date), new CalendarEntry(date, [newActivity]));
                }
                else {
                    this.#state.addActivity(DateUtility.dateToDateString(date), newActivity);
                }
                this.notifyAll(this.#state);
            }
            removeActivity(entry, activityId) {
                this.#state.removeActivity(entry.dateString, activityId);
                this.notifyAll(this.#state);
            }
        }

        class Modal {
            #container;
            #modal;
            constructor() {
                this.#container = document.createElement('div');
                this.#container.classList.add('modal-container');
                this.#modal = document.createElement('div');
                this.#modal.classList.add('modal');
                this.#modal.onclick = e =>
                    e.stopPropagation();

                this.#container.append(this.#modal);

                this.#container.onclick = e => this.close();
            }
            append(innerElement) {
                this.#modal.append(innerElement);
            }
            show() {
                document.getElementById('app').append(this.#container);
            }
            close() {
                this.#container.remove();
            }
        }


        class ButtonTypes {
            static ICON = ['button', 'button-icon'];
            static SUBMIT = ['button', 'button-submit'];
        }

        class Icons {
            static DELETE = 'X';
            static ADD = "+";
            static EMPTY = "";
        }

        class ButtonFactory {
            static createIconButton(icon) {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = icon;
                buttonElement.classList.add(...ButtonTypes.ICON);
                return buttonElement;
            }
            static createSubmitButton(text = 'submit', icon = Icons.EMPTY) {
                const buttonElement = document.createElement('button');
                buttonElement.classList.add(...ButtonTypes.SUBMIT);
                buttonElement.textContent = icon + text;
                return buttonElement;
            }
        }

        class CalendarEntryRenderer {
            #controller;
            constructor(controller) {
                this.#controller = controller;
            }
            render(dateString, entry) {
                const container = document.createElement('div');
                container.classList.add('calendar-entry');
                this.#style(container, dateString, entry);
                const dateLabel = document.createElement('h3');
                dateLabel.classList.add('calendar-entry__header')
                dateLabel.innerText = this.#formatDateString(dateString);
                container.append(dateLabel);
                for (let activity of entry?.activities || []) {
                    const activityContainer = document.createElement('span');
                    activityContainer.classList.add('calendar-entry__activity')
                    activityContainer.innerText = activity.text;
                    activityContainer.style.backgroundColor = activity.color
                    const deleteActivityButton = ButtonFactory.createIconButton(Icons.DELETE);
                    deleteActivityButton.onclick = (e) => {
                        e.stopPropagation();
                        this.#controller.onActivityDeleted(entry, activity.id);
                    }
                    activityContainer.append(deleteActivityButton);
                    container.append(activityContainer);
                }
                container.onclick = (e) => {
                        new AddEntryFormModal((newEntryValue) => {
                            this.#controller.onActivityAdded(DateUtility.dateStringToDate(dateString), newEntryValue);
                        }, dateString).show();
                    }
                return container;
            }
            #style(container, dateString, entry) {
                container.style.borderColor = entry?.color ||
                    (DateUtility.isWeekend(DateUtility.dateStringToDate(dateString)) ? Colors.WEEKEND : Colors.WEEKDAY);
            }
            #formatDateString(dateString) {
                const asDate = DateUtility.dateStringToDate(dateString);
                return asDate.toLocaleDateString();
            }
        }

        class AddEntryFormModal extends Modal {
            constructor(onAdd, dateString) {
                super();
                const formArea = document.createElement('div');
                const title = document.createElement('h2');
                title.textContent = 'Activity for ' + DateUtility.dateStringToDate(dateString).toLocaleDateString();
                const form = document.createElement('form');
                const textLabel = document.createElement('label');
                textLabel.textContent = 'Activity';
                const textInput = document.createElement('input');
                textInput.name = "text";
                textInput.required = true;
                textInput.minLength = 1;
                textInput.maxLength = 255;
                textLabel.append(textInput);
                const colorLabel = document.createElement('label');
                colorLabel.textContent = 'Color';
                const colorSelect = document.createElement('select');
                colorSelect.name = "color";
                for (let color of Colors.ALL) {
                    const colorOption = document.createElement('option');
                    colorOption.textContent = color;
                    colorOption.selected = color === Colors.TRANSPARENT;
                    colorSelect.append(colorOption);
                }
                colorLabel.append(colorSelect);
                const button = ButtonFactory.createSubmitButton("Add", Icons.ADD);
                form.onsubmit = e => {
                    const text = textInput.value;
                    const color = colorSelect.value;
                    super.close();
                    const data = Object.fromEntries(new FormData(event.target));
                    onAdd(CalendarEntryActivity.fromData(data));//new CalendarEntryActivity(text, color));
                };
                form.append(textLabel, colorLabel, button);
                formArea.append(title, form);
                super.append(formArea);
            }
        }

        class View extends Observer {
            #controller;
            #entryFormElement;
            #calendarListElement;
            #calendarEntryRenderer;
            #visibleDaysInput;
            constructor(controller, calendarEntryRenderer) {
                super();
                this.#controller = controller;
                this.#calendarEntryRenderer = calendarEntryRenderer;
                this.#entryFormElement = document.getElementById("entryForm");
                this.#calendarListElement = document.getElementById("calendarList");
                this.#visibleDaysInput = document.getElementById("visibleDaysInput");
                this.#visibleDaysInput.value = 7;
                const visibleDaysInputListener = (e) =>
                    this.#controller.onVisibleDaysInputUpdated(this.#visibleDaysInput.value);
                this.#visibleDaysInput.onclick = visibleDaysInputListener;
                this.#visibleDaysInput.onchange = visibleDaysInputListener;
            }
            onUpdate(state) {
                let date = new Date();
                this.#calendarListElement.textContent = ''; // remove all children
                for (let i = 0; i < state.daysVisible; i++) {
                    const d = new Date(date); // clone to prevent weirdness
                    const calendarEntryElement = this.#calendarEntryRenderer.render(DateUtility.dateToDateString(date), state.calendarEntries[DateUtility.dateToDateString(date)]);
                    this.#calendarListElement.append(calendarEntryElement);
                    
                    date.setDate(date.getDate() + 1);

                }
            }
        }

        class Controller {
            #model;
            constructor(model) {
                this.#model = model;
            }
            onVisibleDaysInputUpdated(newVisibleDays) {
                this.#model.setDaysVisible(newVisibleDays);
            }
            onActivityAdded(date, newActivity) {
                this.#model.addActivity(date, newActivity);
            }
            onActivityDeleted(entry, activityId) {
                this.#model.removeActivity(entry, activityId);
            }
        }

        class LocalStorageService {
            static #key = "kid_calendar";
            constructor() {
            }
            save(data) {
                localStorage.setItem(LocalStorageService.#key, JSON.stringify(data, null, 2));
            }
            open() {
                const stringData = localStorage.getItem(LocalStorageService.#key);
                if (!stringData) {
                    return null;
                }
                else {
                    return JSON.parse(stringData);
                }
            }
        }

        class StorageManager {
            constructor(implementation) {
                this.implementation = implementation;
            }
            onUpdate(state) {
                this.implementation.save(state);
            }
        }

        (() => {
            const storageImplementation = new LocalStorageService();
            const storageManager = new StorageManager(storageImplementation);
            const startingState = State.fromData(storageImplementation.open()) || new State();
            const model = new Model(startingState);
            const controller = new Controller(model);
            const view = new View(controller, new CalendarEntryRenderer(controller));
            model.addObserver(view);
            model.addObserver(storageManager);
            model.start();
        })()

    </script>
</body>

</html>